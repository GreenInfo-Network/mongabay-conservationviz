<!-- new.html -->
<!DOCTYPE html>
<meta charset="utf-8">

<head>
  <link rel="stylesheet" href="index.css" type="text/css" media="all" />

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>

  <!-- TopoJSON for loading polygon data more efficiently than GeoJSON -->
  <script type="text/javascript" src="https://d3js.org/topojson.v1.min.js"></script>

    <!-- D3, jQuery, lodash, papa parse -->
  <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <!-- <script src="https://d3js.org/d3.v4.min.js"></script> -->
  <script src="https://d3js.org/d3-queue.v3.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.3/papaparse.min.js"></script>
  <!-- Local Javascript -->
  <!-- <script src="./index.js"></script> -->

  <style>

    body {margin:0; padding: 0;}

    svg {
      box-shadow:none;
      background:#fff;
    }

    svg g {
      opacity: 1;
    }

    svg g.groups {
      border: 1px solid #ccc;
    }

    rect {
      width:19px; height: 19px;
      fill: cornflowerblue;
    }

    rect.plus {
      fill: #309223;
    }
    rect.neutral {
      fill: #FACB57;
    }
    rect.minus {
      fill: #D7067C;
    }
    rect.weak {
      opacity: 0.5;
    }

  </style>

</head>

<body>

  <div style="margin:1em;">
    <button onClick="draw(nest(rawdata,'variable'))">Switch to data by variable</button>
    <button onClick="draw(nest(rawdata,'theme'))">Switch to data by theme</button>
    <button onClick="draw(nest(rawdata, curr_field, {key:'strength',value:'Direct correlation'}))">Filter by strength</button>
  </div>

  <svg></svg>

  <script>

  var countriesKeyed;
  var dataNested;
  var rawdata;
  var curr_field;

  d3.queue()
      .defer(d3.csv, 'data/countries.csv')
      .defer(d3.csv, 'data/data.csv')
      .await(main);
  
  function main(error, countries, data) {
    if (error) throw error;
    
    // parse country data
    countries = countries.map(function(d) {
      return {
        lat: +d.latitude,
        lon: +d.longitude,
        abrev: d.country,
        count: 0,
        name: d.name
      }
    });
    
    data.forEach(function(d) {
      d.valence = +d.valence;
    })
    
    // create a d3 map, not the same as Array.prototype.map
    countriesKeyed = d3.map(countries, function(d) {
      return d.name;
    });
    
    // unique list of themes
    // not needed at this time
    var themes = data.reduce(function(acc, d) {
      if (acc.indexOf(d.theme) === -1) {
        acc.push(d.theme);
      }
      
      return acc;
    }, [])
    .sort();
    
    // keep a reference to rawdata
    rawdata = data;

    var dataNested = nest(data,"theme");
    draw(dataNested);

  }

  // nest our data on selected field, then either "plus" or "minus" depending on value of "valence"
  // optionally pass a filter object in the form of {key: "fieldname to filter", value: "value to match"}
  function nest(data,field,filter) {
    curr_field = field; // keep a reference to the current field displayed

    if (filter) {
      data = data.filter(function(d) {
        return d[filter.key] == filter.value
      })
    }

    return d3.nest()
        .key(function(d) { return d[field] })
        .key(function(d) {  if (d.valence > 0) { return 'plus'; } return 'minus'; })
        .entries(data);
  }


  // get the container in global scope
  var svg = d3.select("svg")
    .attr("width",1200) // updated on enter, see below
    .attr("height",1200);

  var rowh = 55;
  var subh = 20;
  var subw = 300;
  var rectw = 20;
  var t = d3.transition()
      .duration(750);

  //
  // MAIN UPDATE FUNCTION
  //
  function draw(data) {

    console.log("data passed to draw() ",data);

    var rows = svg.selectAll("g")
      .data(data, function(d){return d.key});

    // EXIT rows
    rows.exit()
      .selectAll("g")
      .transition()
      .duration(1000)
      .style("opacity", 1e-6)
      .remove();

    // ENTER rows
    var rowsenter = rows.enter()
      .append("g")
        .style('opacity',1)
        .classed("rows",true)
        .attr("transform", function(d,i) { return "translate(0," + i * rowh + ")" })

    rows.append("g")
        .append("text")
          .attr("transform", function(d,i) { return "translate(30,25)" })
          .text(function(d) { return d.key });

    // create two sub-groups for charts
    var subgroups = rows.selectAll("g")
      .data(function(d){ return d.values }, function(d) {return d.key});

    // ENTER subgroups
    subgroups.enter()
      .append("g")
      .attr("class","subgroups")
      .attr("transform", function(d,i) { return "translate(100," + i * subh + ")" });

    // charts
    var chart = subgroups.selectAll("rect")
      .data(function(d) {return d.values;}, function(d) {return d.zb_id})

    // EXIT old elements not present in new data.
    chart.exit()
      .transition()
      .duration(1000)
      .style("opacity", 1e-6)
      .remove();

    // UPDATE old elements present in new data.
    chart
      .attr("y", 0)
      .style("fill-opacity", 1)
      .transition(t)
      .attr("x",function(d, i) { return i * rectw})

    // ENTER new elements not present in old
    var chartenter = chart.enter()
      .append("rect")
      // .attr("transform", function(d,i) { return "translate(" + i * rectw + ",0)" })
      .attr("x",function(d, i) { return i * rectw})
      .classed("neutral",function(d) { return d.valence == 0 })
      .classed("plus",function(d) { return d.valence > 0 })
      .classed("minus",function(d) { return d.valence < 0 })
      .classed("weak", function(d) {return d.strength != "Direct correlation" ? true : false});
    
  } // draw()

  </script>

</body>

</html>

