<!-- new.html -->
<!DOCTYPE html>
<meta charset="utf-8">

<head>

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>

  <!-- TopoJSON for loading polygon data more efficiently than GeoJSON -->
  <script type="text/javascript" src="https://d3js.org/topojson.v1.min.js"></script>

  <!-- D3, jQuery, lodash -->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
  
  <!-- Local Javascript -->
  <!-- <script src="./index.js"></script> -->
  <link rel="stylesheet" href="new.css" type="text/css" media="all" />

  <!-- select2, a select box enhancer for jquery -->
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>

  <!-- fonts/ -->
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">


</head>

<body>

  <div style="margin:1em;">
    <!-- <button onClick="draw(nest(rawdata,'variable'))">Switch to data by variable</button> -->
    <!-- <button onClick="draw(nest(rawdata,'theme'))">Switch to data by theme</button> -->
    <button style="margin-right:4px;" onClick="draw(nest(rawdata, curr_field, {key:'strength',value:'Direct correlation'}),d3.select('svg.top'))">Filter by strength</button>

    <select id="country" required>
      <option value="" disabled selected>Select a country</option>
    </select>

  </div>

  <svg class="top"></svg>

  <script>

  var countriesKeyed;
  var dataNested;
  var rawdata;

  var rowh = 55;
  var subh = 20;
  var subw = 300;
  var rectw = 20;
  var t = d3.transition()
      .duration(750);

  d3.queue()
      .defer(d3.csv, 'data/countries.csv')
      .defer(d3.csv, 'data/data.csv')
      .await(main);
  
  function main(error, countries, data) {
    if (error) throw error;
    
    // parse country data
    countries = countries.map(function(d) {
      return {
        lat: +d.latitude,
        lon: +d.longitude,
        abrev: d.country,
        count: 0,
        name: d.name
      }
    });
    
    // data setup
    var countries = [];
    data.forEach(function(d) {
      // transform string valence into intenger
      d.valence = +d.valence;
      // generate list of countries present in data
      // d.country can be a list of countries, so check for that, and split if so
      var country = d.country;
      country = country.indexOf(",") ? country.split(",") : [country];
      countries = _.union(countries, country.map(function(c) { return c.trim() }));
    });

    countries = _.without(_.uniq(countries.sort()), "");
    console.log(countries);

    countries.forEach(function(country) {
      d3.select("select#country")
        .append("option")
        .text(country)
        .attr("value",country.trim())
    });
        
    // keep a reference to rawdata
    rawdata = data;

    // get the container for the top chart
    var svg = d3.select("svg.top")
      .attr("width",1200) 
      .attr("height",1200);

    var dataNested = nest(data,"theme",false);
    draw(dataNested,svg);

  }

  // nest our data on selected field, then either "plus" or "minus" depending on value of "valence"
  // optionally pass a filter object in the form of {key: "fieldname to filter", value: "value to match"}
  function nest(data,field,filter) {

    if (filter) {
      data = data.filter(function(d) {
        // country requires more permissive filtering (match one country in a list)
        return filter.key == "country" ? d["country"].indexOf(filter.value) > -1  : d[filter.key] == filter.value
      })
    }

    return d3.nest()
        .key(function(d) { return d[field] })
        .key(function(d) {  if (d.valence > 0) { return 'plus'; } return 'minus'; }).sortKeys(d3.descending)
        .entries(data);
  }

  //
  // MAIN UPDATE FUNCTION
  //
  function draw(data,container) {

    console.log("data passed to draw() ",data);

    // select rows
    var rows = container.selectAll("g")
      .data(data, function(d){return d.key});

    // EXIT rows
    rows.exit()
      .selectAll("g")
      .remove();

    // ENTER rows
    var rowsenter = rows.enter()
      .append("g")
        .style("opacity",1)
        .classed("rows",true)
        .attr("transform", function(d,i) { return "translate(0," + i * rowh + ")" })
    
    // select text labels
    var labels = rows.selectAll("g")
      .data(function(d) {return [d.key]});

    labels.enter()
      .append("g")
        .append("text")
        .style("opacity",1)
        .attr("transform", function(d,i) { return "translate(30,25)" })
        .text(String);

    // create two sub-groups for charts
    var subgroups = rows.selectAll("g")
      .data(function(d){ return d.values }, function(d) {return d.key});

    // EXIT subgroups
    subgroups.exit()
      .selectAll("g")
      .remove();

    // ENTER subgroups
    subgroups.enter()
      .append("g")
      .attr("class","subgroups")
      .attr("transform", function(d,i) { return "translate(100," + i * subh + ")" });

    // charts
    var chart = subgroups.selectAll("rect")
      .data(function(d) {return d.values});

    // EXIT chart
    chart.exit()
      .transition(t)
      .style("opacity", 1e-6)
      .remove();

    // UPDATE old elements present in new data.
    chart
      .attr("y", 0)
      .style("fill-opacity", 1)
      .transition(t)
      .attr("x",function(d, i) { return i * rectw})

    // ENTER new elements not present in old
    var chartenter = chart.enter()
      .append("rect")
      // .attr("transform", function(d,i) { return "translate(" + i * rectw + ",0)" })
      .attr("x",function(d, i) { return i * rectw})
      .classed("neutral",function(d) { return d.valence == 0 })
      .classed("plus",function(d) { return d.valence > 0 })
      .classed("minus",function(d) { return d.valence < 0 })
      .classed("weak", function(d) {return d.strength != "Direct correlation" ? true : false});
    
  } // draw()





  </script>

</body>

</html>

