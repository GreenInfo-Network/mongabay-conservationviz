<!DOCTYPE html>
<meta charset="utf-8">
<style>

table {
}

table td {
  padding:5px;
}

td.chart span {
  display:inline-block;
  width:19px; height: 19px;
  margin:1px;
}

td.chart span.plus {
  background: steelblue;
}

td.chart span.minus {
  background: red;
}

td.chart div.minus-div {
  margin-top: -4px;
}

table {table-layout: fixed;}
table td:first-child {max-width:200px;}

/*.chart text {
  fill: white;
  font: 10px sans-serif;
  text-anchor: end;
}*/

</style>

<body></body>

</html>

<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>

<script>

// var data = [4, 8, 15, 16, 23, 42];

var width = 1000,
    barHeight = 20;

var x = d3.scale.linear()
    .domain([0, 10])
    .range([0, width]);

var chart = d3.select("body").append("table");

d3.csv("data.csv", function(data) {

  // pre-processing....
  // filter data to get just the current theme
  var filtered = data.filter(function(d) {return d.theme == 'ENV'});
  // get a distinct list of variables from this subset
  var variables = get_distinct(filtered, 'variable');
  // create an array of objects keyed by variable, with data for that variable collected within
  var output = [];
  variables.forEach(function(variable){
    out = {};
    out["name"]  = variable;
    out["plus"]  = [];
    out["minus"] = [];
    out["count"] = 0;
    filtered.forEach(function(row){
      if (row.variable == variable) {
        out.count += 1;
        row.valence > -1 ? out["plus"].push(row) : out["minus"].push(row);
      }
    });
    output.push(out);
  });

  console.log(output);


  // to do here: simplify data to just what you need
  // or a series of those things? 
  // length of g is more than just the lenght of output, as we have to take valence into account
  // given design, best way forward might be a table (gasp)
  // add rows instead of <g>'s
  // then add <div> instead of <rect>


    // rows will determine if we have 1 or 2 sections for each variable    
    // var rows = 0;
    // if (datum.minus) rows += 1;
    // if (datum.plus)  rows += 1;

  var tr = chart.selectAll("tr")
    .data(output).enter()
    .append("tr");

  tr.append('td')
    .attr('class', 'name')
    .html(function(d) { return d.name; });

  var cell = tr.append("td")
    .attr('class','chart');
  
  var plus = cell.append("div")
    .attr('class','plus-div');

  var minus = cell.append("div")
    .attr('class','minus-div');

  plus.selectAll("span")
    .data(function(d) {
      return range(d.plus.length);
    })
    .enter().append('span')
    .attr('class','plus');

  minus.selectAll("span")
    .data(function(d) {
      return range(d.minus.length);
    })
    .enter().append('span')
    .attr('class','minus');

      // .data(function(d) { debugger; });
      // .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });

    // data always expects an array, take count and make a consecutive array from it with range()
    // bar.selectAll("rect").data(function(d) {debugger; return range(d.count) })
    //   .enter().append('rect')
    //     .attr("width", barHeight - 1)
    //     .attr("height", barHeight - 1)
    //     .attr("transform", function(d,i) { return "translate(" + i * barHeight + ",0)";});


}); // d3.csv
  


// utility function to turn an integer into an array from 0 to n
function range(n) {
  var foo = [];
  for (var i = 0; i <= n - 1; i++) {
    foo.push(i)
  }
  return foo;
}

function get_distinct(array, key) {
  var unique = {};
  var distinct = [];
  for( var i in array ){
    if( typeof(unique[array[i][key]]) == "undefined"){
      distinct.push(array[i][key]);
    }
    unique[array[i][key]] = 0;
  }
  return distinct;
}


</script>
